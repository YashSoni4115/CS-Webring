/**
 * CS Webring Widget
 * Fetches /data/members.json and renders navigation widget
 */
(function() {
  'use strict';

  const BASE_URL = 'https://cs-webring.pages.dev';;
  const DATA_URL = BASE_URL + '/data/members.json';;

  class WebringWidget {
    constructor(options = {}) {
      this.currentSite = options.currentSite || window.location.origin;
      this.container = options.container || '#cs-webring';
      this.theme = options.theme || 'default';
      this.sites = [];
      this.currentIndex = -1;
      this.init();
    }

    async init() {
      try {
        await this.loadSites();
        this.findCurrentSite();
        this.render();
      } catch (err) {
        console.error('CS Webring Widget Error:', err);
      }
    }

    async loadSites() {
      const res = await fetch(DATA_URL);
      this.sites = await res.json();
    }

    findCurrentSite() {
      const host = new URL(this.currentSite).hostname;
      this.currentIndex = this.sites.findIndex(s => {
        try {
          return new URL(s.website).hostname === host;
        } catch { return false; }
      });
    }

    getPrev() {
      if (this.sites.length === 0) return null;
      const i = (this.currentIndex <= 0 ? this.sites.length : this.currentIndex) - 1;
      return this.sites[i];
    }

    getNext() {
      if (this.sites.length === 0) return null;
      const i = (this.currentIndex + 1) % this.sites.length;
      return this.sites[i];
    }

    getRandom() {
      if (this.sites.length === 0) return null;
      let i;
      do { i = Math.floor(Math.random() * this.sites.length); }
      while (i === this.currentIndex && this.sites.length > 1);
      return this.sites[i];
    }

    render() {
      const el = document.querySelector(this.container);
      if (!el) return console.error('Container not found:', this.container);

      const prev = this.getPrev();
      const next = this.getNext();

      el.innerHTML = `
        <div class="webring-widget webring-theme-${this.theme}">
          <span class="webring-label">CS Webring</span>
          <nav class="webring-nav">
            <a href="${prev?.website || '#'}" class="webring-link">← Prev</a>
            <a href="${BASE_URL}" class="webring-link">Home</a>
            <a href="#" class="webring-link webring-random">Random</a>
            <a href="${next?.website || '#'}" class="webring-link">Next →</a>
          </nav>
        </div>
      `;

      el.querySelector('.webring-random')?.addEventListener('click', e => {
        e.preventDefault();
        const r = this.getRandom();
        if (r) window.location.href = r.website;
      });
    }
  }

  window.WebringWidget = WebringWidget;

  document.addEventListener('DOMContentLoaded', () => {
    if (document.querySelector('#cs-webring')) {
      window.csWebring = new WebringWidget();
    }
  });
})();
